from sklearn.naive_bayes import BaseNB
from sklearn.neighbors import KernelDensity
import numpy as np

class KDE_NaiveBayes(BaseNB):
    def __init__(self, bandwidth=1.0):
        self.bandwidth = bandwidth

    def fit(self, X, y):
        self.classes_ = np.unique(y)
        self.kde_models_ = {}
        self.class_priors_ = {}

        for c in self.classes_:
            X_c = X[y == c]
            self.class_priors_[c] = len(X_c) / len(X)
            self.kde_models_[c] = [KernelDensity(bandwidth=self.bandwidth).fit(X_c.iloc[:, i].values.reshape(-1, 1))
                                   for i in range(X.shape[1])]
        return self

    def predict_log_proba(self, X):
        log_probs = []
        for c in self.classes_:
            log_prior = np.log(self.class_priors_[c])
            log_likelihood = np.sum([
                self.kde_models_[c][i].score_samples(X.iloc[:, i].values.reshape(-1, 1))
                for i in range(X.shape[1])
            ], axis=0)
            log_probs.append(log_prior + log_likelihood)
        return np.array(log_probs).T

    def predict(self, X):
        return self.classes_[np.argmax(self.predict_log_proba(X), axis=1)]
